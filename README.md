# build-your-own-pnpm

## 项目目标
构建一个极简版的 pnpm，用于学习 pnpm 的核心工作原理。

## 核心特性 Todo List

### 阶段一：基础架构 (必须完成) ✅
- [x] **项目初始化**
  - [x] 创建基本的项目结构
  - [x] 设置 TypeScript 配置
  - [x] 添加必要的依赖包
  - [x] 创建 CLI 入口文件

- [x] **核心模块设计**
  - [x] 创建 Package 类 (表示单个包)
  - [x] 创建 Registry 类 (处理 npm 仓库请求)
  - [x] 创建 Store 类 (中心化存储管理)
  - [x] 创建 Linker 类 (处理符号链接)

### 阶段二：基本功能实现 (核心特性) 🚧
- [x] **中心化存储 (pnpm 的核心特性)**
  - [x] 实现全局 store 目录管理 (`~/.mini-pnpm-store`) - 基础架构完成
  - [ ] 包的哈希计算和存储 - 需要完善哈希算法
  - [ ] 避免重复下载相同版本的包 - 逻辑框架已有，需要实现

- [ ] **符号链接机制**
  - [ ] 实现硬链接到 store 的包
  - [ ] 创建 node_modules 的符号链接结构 - 基础框架已有
  - [ ] 处理依赖的嵌套链接

- [x] **包安装核心逻辑** - 基础版本
  - [x] 解析 package.json 依赖
  - [x] 从 npm registry 下载包 - API 交互完成，文件下载待实现
  - [x] 版本解析和冲突处理 - 基础版本完成
  - [ ] 创建链接结构 - 框架完成，实际链接待实现

### 阶段三：命令行接口 ✅
- [x] **基本命令实现**
  - [x] `mini-pnpm install` - 安装所有依赖 (基础框架，实际安装待完善)
  - [x] `mini-pnpm add <package>` - 添加新依赖 ✅ 完全可用
  - [x] `mini-pnpm remove <package>` - 移除依赖 ✅ 完全可用
  - [x] `mini-pnpm list` - 列出已安装的包 ✅ 完全可用

- [ ] **锁定文件 (简化版)**
  - [ ] 创建 `pnpm-lock.yaml` 的简化版
  - [ ] 记录确切的包版本和依赖树
  - [ ] 读取和写入锁定文件

### 阶段四：优化和完善 (可选) ⏳
- [ ] **缓存机制**
  - [ ] 实现下载缓存
  - [ ] 元数据缓存

- [x] **错误处理** - 基础版本
  - [x] 网络错误处理
  - [x] 包不存在的处理
  - [x] 版本冲突的友好提示

- [ ] **性能优化**
  - [ ] 并发下载
  - [ ] 增量安装

## 已完成功能总结 🎉

### ✅ 完全可用的功能
- **项目架构**: 完整的 TypeScript 项目结构
- **CLI 工具**: `add`、`remove`、`list` 命令完全可用
- **Registry 交互**: 可以获取包信息、解析版本
- **基础错误处理**: 网络错误、包不存在等情况的处理

### 🚧 部分完成的功能
- **install 命令**: 可以解析依赖，但还未实现实际下载和链接
- **Store 管理**: 基础架构完成，哈希计算和存储逻辑待完善
- **Linker**: 符号链接框架完成，实际链接创建待实现

### 📊 进度统计
- **阶段一 (基础架构)**: 100% 完成 ✅
- **阶段二 (核心功能)**: 30% 完成 🚧
- **阶段三 (CLI 接口)**: 80% 完成 ✅
- **阶段四 (优化完善)**: 10% 完成 ⏳

## 技术栈
- **语言**: TypeScript
- **CLI 框架**: Commander.js
- **HTTP 请求**: Axios
- **文件操作**: fs-extra
- **压缩解压**: tar
- **哈希计算**: crypto

## 项目结构
```
src/
├── cli/                 # 命令行接口
│   ├── commands/        # 各种命令实现
│   └── index.ts         # CLI 入口
├── core/                # 核心功能
│   ├── package.ts       # Package 类
│   ├── registry.ts      # Registry 类
│   ├── store.ts         # Store 类
│   └── linker.ts        # Linker 类
├── utils/               # 工具函数
│   ├── hash.ts          # 哈希计算
│   ├── download.ts      # 下载工具
│   └── fs.ts            # 文件系统工具
└── types/               # TypeScript 类型定义
    └── index.ts
```

## 下一步开发重点 🎯

### 优先级 1 (核心功能)
1. **实现包下载**: 完善 `Registry.downloadPackage()` 和 `Downloader` 类
2. **完善 Store 存储**: 实现真正的哈希计算和包存储
3. **实现符号链接**: 完善 `Linker` 类的链接创建功能

### 优先级 2 (完善功能)
4. **依赖树解析**: 处理复杂的依赖关系
5. **锁文件支持**: 实现 `pnpm-lock.yaml` 生成和读取
6. **Semver 支持**: 完整的版本范围解析

## 学习重点
1. **理解 pnpm 的核心优势**: 如何通过链接避免重复存储
2. **符号链接 vs 硬链接**: 何时使用哪种链接方式
3. **依赖解析算法**: 如何构建扁平化的依赖树
4. **包管理生态**: npm registry API 的使用

## 当前可用命令 🚀
```bash
# 构建项目
pnpm build

# 在测试项目中使用
cd test-project

# 添加依赖 (完全可用)
../dist/cli/index.js add lodash@4.17.21

# 移除依赖 (完全可用)
../dist/cli/index.js remove lodash

# 列出依赖 (完全可用)
../dist/cli/index.js list

# 安装依赖 (解析功能可用，实际安装待完善)
../dist/cli/index.js install
```
